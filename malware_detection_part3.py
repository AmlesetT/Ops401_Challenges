#!/usr/bin/python3

# Script Name:                  Ops 401 - Challenge 33
# Author:                       Amleset Tesfamariam, CF Ops lecture 401, ChatGPT
# Date of latest revision:      03/27/2024
# Purpose:                      To existing Python script, add features including: successfully conecting to VirusTotal API, automatically comparing target file's md5 hash with hash values on VirusTotal API, and detailing number of positive malware detected.
# Reason:                       It is critical to be able to create and use malware detecting tools to better prevent and help protect sensitive data.


import os
import hashlib
import time
import requests

def generate_md5(file_path):
    hash_md5 = hashlib.md5()
    with open(file_path, "rb") as file: 
        for chunk in iter(lambda: file.read(4096), b""):
            hash_md5.update(chunk)
    return hash_md5.hexdigest()

# Function to query VirusTotal API
def query_virustotal(md5_hash, api_key):
    url = f"https://www.virustotal.com/vtapi/v2/file/report?apikey={api_key}&resource={md5_hash}"
    response = requests.get(url)
    json_response = response.json()
    if "positives" in json_response:
        return json_response["positives"]
    else:
        return 0

# Searching files in the directory 
def search_files(file_name, directory, api_key):
    hits = 0
    scanned_files = 0

    for root, _, files in os.walk(directory):
        for file in files:
            if file == file_name:
                scanned_files += 1
                file_path = os.path.join(root, file)
                md5_hash = generate_md5(file_path)
                positives = query_virustotal(md5_hash, api_key)

                if positives > 0:
                    hits += 1
                    print(f"File Name: {file}")
                    print(f"File Path: {file_path}")
                    print(f"MD5 Hash: {md5_hash}")
                    print(f"Positives Detected: {positives}")
                    print("=" * 50)

    print("\nSearch Summary:")
    print(f"Files Scannedd: {scanned_files}")
    print(f"Hits Found: {hits}")

def main():
    file_name = input("Please enter the file name you would like to search for: ")
    directory = input("Please enter the directory you would like to search in: ")
    api_key = input("Please enter your VirusTotal API key: ")

    if os.path.isdir(directory):
        print("\nSearching for files...")
        search_files(file_name, directory, api_key)
    else:
        print("Invalid directory path. Please try again.")

if __name__ == "__main__":
    main()

